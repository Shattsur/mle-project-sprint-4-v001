# 🎵 Описание проекта
Сервис музыкальных рекомендаций, который предоставляет персонализированные рекомендации треков на основе:

**Офлайн-рекомендаций (ALS модель + популярные треки)**  
**Онлайн-рекомендаций (похожие треки на основе истории прослушиваний)**  
**Гибридного подхода (интеллектуальное смешивание обоих методов)**

## 🏗️ Архитектура решения
```
┌─────────────────┐    HTTP запросы    ┌──────────────────┐
│   Клиент        │───────────────────▶│   FastAPI        │
│   (браузер/     │◀───────────────────│   Сервис         │
│   приложение)   │    JSON ответы     │   (Python)       │
└─────────────────┘                    └─────────┬────────┘
                                                 │
                                                 │ Загрузка данных
                                                 ▼
                                        ┌──────────────────┐
                                        │   Yandex Cloud S3│
                                        │   (Parquet файлы)│
                                        └──────────────────┘
```

## 🚀 Быстрый старт

### 1. Установка зависимостей
```bash
# Активация виртуального окружения 
# Создать новое виртуальное окружение можно командой:

python3 -m venv env_recsys_start

# После его инициализации следующей командой

. env_recsys_start/bin/activate

# Установка пакетов
pip install -r requirements.txt
```

### 2. Настройка окружения
Создайте файл `.env` в корне проекта:

```env
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here
S3_BUCKET_NAME=s3-student-mle-20250704-4a1b0ab232-freetrack
```

### 3. Проверка данных
```bash
python check_data.py
```

## 🖥️ Запуск сервиса
**Способ 1:**
```bash
python recommendations_service.py
```
**Способ 2:**
```bash
uvicorn recommendations_service:app --host 127.0.0.1 --port 8000 --reload
```
**Способ 3 (Production):**
```bash
uvicorn recommendations_service:app --host 0.0.0.0 --port 8000 --workers 4
```

После запуска сервис будет доступен по адресам:
- Основной URL: http://127.0.0.1:8000  
- API документация: http://127.0.0.1:8000/docs  
- Альтернативная документация: http://127.0.0.1:8000/redoc

## 🌐 Тестирование API
### Через браузер
**Проверка здоровья сервиса**
```
http://127.0.0.1:8000/health
```

**Получение рекомендаций**
```
http://127.0.0.1:8000/recommend/0
http://127.0.0.1:8000/recommend/123?limit=5
http://127.0.0.1:8000/recommend/456?online_history=53404,33311009
```

**Информация о треке**
```
http://127.0.0.1:8000/track/53404
```

### Через командную строку
```bash
curl http://127.0.0.1:8000/health
curl http://127.0.0.1:8000/recommend/0
curl "http://127.0.0.1:8000/recommend/0?online_history=53404,33311009&limit=5"
curl http://127.0.0.1:8000/track/53404
```

### Через Python
```bash
python test_service.py
```

## 🎯 Стратегия рекомендаций
### Офлайн-рекомендации
- Персональные (ALS): Матричная факторизация на основе истории прослушиваний  
- Популярные: Топ-N самых прослушиваемых треков  
- Случайные: Fallback из каталога треков

### Онлайн-рекомендации
- Похожие треки: На основе последних 5 прослушиваний пользователя  
- Content-based: Рекомендации по схожести музыкальных характеристик

### Алгоритм смешивания
```python
# Пропорция: 70% офлайн, 30% онлайн
offline_recs = 70% от общего лимита
online_recs = 30% от общего лимита

# Приоритет: офлайн рекомендации доминируют
# Резерв: онлайн рекомендации добавляют релевантность
```

## 📚 API документация
### GET /health
Проверка статуса сервиса и загрузки данных
```json
{
  "status": "healthy",
  "data_loaded": true,
  "timestamp": "2024-01-15T10:30:00"
}
```

### GET /recommend/{user_id}
Получение рекомендаций для пользователя
Параметры:
- `user_id` — обязательный ID пользователя  
- `limit` — количество рекомендаций (по умолчанию 10)  
- `online_history` — ID треков через запятую для онлайн-рекомендаций

### GET /track/{track_id}
Получение информации о треке
```json
{
  "track_name": "Smells Like Teen Spirit",
  "artist_names": ["Nirvana"],
  "genre_names": ["alternative", "rock", "allrock"]
}
```

## 🛠️ Требования
### Системные требования
- Python 3.8+
- 4GB+ RAM
- 1GB+ свободного места

### Python зависимости
```txt
fastapi==0.104.1
uvicorn==0.24.0
pandas==2.1.3
numpy==1.24.3
python-dotenv==1.0.0
boto3==1.28.62
requests==2.31.0
pyarrow==14.0.1
pydantic==2.5.0
```

## 📁 Структура проекта
```
mle-project-sprint-4-v001/
├── recommendations_service.py
├── test_service.py
├── check_data.py
├── requirements.txt
├── .env
├── data/
│   ├── items.parquet
│   ├── similar.parquet
│   ├── personal_als.parquet
│   └── top_popular.parquet
└── test_service.log
```

## 🔧 Устранение неполадок
**Проблема:** "Не удается получить доступ к сайту"  
**Решение:** Используйте `http://127.0.0.1:8000`

**Проблема:** Ошибки подключения к S3  
**Решение:** Проверьте `.env` и доступность бакета

**Проблема:** "Port already in use"  
**Решение:**  
```bash
uvicorn recommendations_service:app --host 127.0.0.1 --port 8080
```

## 📊 Мониторинг и логи
Сервис логирует ключевые события:
- Загрузка данных при старте
- Запросы рекомендаций
- Ошибки и предупреждения

```bash
python recommendations_service.py > service.log 2>&1
```
